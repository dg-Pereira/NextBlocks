{"version":3,"file":"lib.min.js","sources":["../src/lib.js"],"sourcesContent":["/**\n *\n * @module      mod_nextblocks/env\n * @copyright   2023 Duarte Pereira<dg.pereira@campus.fct.unl.pt>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals Blockly */\n/* globals javascript */\n\n/**\n * Injects the box for inserting the program input below the blockly area\n * @param {Number} i the index of the input box, to avoid repetition of ids\n */\nexport const injectInputBox = (i) => {\n    // Create input box for program input\n    const inputBox = document.createElement('input');\n    inputBox.setAttribute('type', 'text');\n    inputBox.setAttribute('id', 'programInputBox' + i);\n\n    // Create button to submit input\n    const submitButton = document.createElement('button');\n    submitButton.setAttribute('id', 'programInputButton' + i);\n    submitButton.setAttribute('type', 'button');\n    submitButton.innerHTML = 'Submit';\n\n    // Insert input box and button below blockly area\n    const blocklyDiv = document.getElementById('blocklyDiv');\n    blocklyDiv.insertAdjacentElement('afterend', inputBox);\n    inputBox.insertAdjacentElement('afterend', submitButton);\n};\n\n/**\n * Inserts the new program code in the code div below the blockly area, replacing the old one if it exists\n * @param {string} code the new program code to be displayed\n * @param {number} inputFuncDecsN the number of forced input function declarations\n */\nexport const replaceCode = (code, inputFuncDecsN) => {\n    const codeDiv = document.getElementById('codeDiv');\n    codeDiv.innerHTML = formatCodeHTML(code, inputFuncDecsN);\n};\n\n/**\n * Formats the code with correct HTML structure to be displayed in the code div\n * TODO: implement this function\n * @param {string} code the code text to be formatted (string literal)\n * @param {number} inputFuncDecsN the number of forced input function declarations\n * @param {boolean} debugMode whether to display the code as is, or with the wrapper function\n * @returns {string} the formatted code\n */\nconst formatCodeHTML = (code, inputFuncDecsN, debugMode = true) => {\n    if (!debugMode) {\n        code = removeForcedInputFunctions(code, inputFuncDecsN);\n        code = removeOutputString(code);\n        code = removeCustomFunctions(code);\n        code = removeWrapperFunction(code);\n        return \"<pre>\" + code + \"</pre>\";\n    } else {\n        // Code is string literal\n        return \"<pre>\" + code + \"</pre>\";\n    }\n};\n\n/**\n * @param {string} code the code to be modified\n * @param {number} inputFuncDecsN the number of forced input function declarations\n * @returns {string} the code without the forced input function declarations\n */\nfunction removeForcedInputFunctions(code, inputFuncDecsN) {\n    const lines = code.split('\\n');\n    lines.splice(0, inputFuncDecsN * 3);\n    return lines.join('\\n');\n}\n\n/**\n * Removes the wrapper function from the code for presentation purposes\n * Removes first two and last three lines\n * @param {String} code the code to be modified\n * @returns {String} the code without the wrapper function\n */\n// eslint-disable-next-line no-unused-vars\nconst removeWrapperFunction = (code) => {\n    const lines = code.split('\\n');\n    lines.splice(0, 2);\n    lines.splice(-3);\n    return lines.join('\\n');\n};\n\nconst removeCustomFunctions = (code) => {\n    const lines = code.split('\\n');\n    lines.splice(0, 6);\n    return lines.join('\\n');\n};\n\nconst removeOutputString = (code) => {\n    const lines = code.split('\\n');\n    lines.splice(0, 1);\n    return lines.join('\\n');\n};\n\n/**\n * Runs the tests on the given workspace and returns an array of booleans, one for each test, indicating whether\n * the test passed or not\n * @param {WorkspaceSvg} workspace the workspace to run the tests on\n * @param {{}} tests the tests to run\n * @param {string} inputFuncDecs the function declarations for the forced input functions\n * @returns {any[]} an array of booleans, one for each test, indicating whether the test passed or not\n */\nexport const runTests = (workspace, tests, inputFuncDecs) => {\n    const code = getWorkspaceCode(workspace, inputFuncDecs);\n    let results = [];\n    tests.forEach((test) => {\n        let thisTestCode = code; // Need to copy, so that the code is not modified for the next test\n        const inputs = test.inputs;\n        inputs.forEach((input) => {\n            const prompt = Object.keys(input)[0];\n            const values = input[prompt];\n\n            const inputIndex = thisTestCode.lastIndexOf(prompt);\n            // Get index of first string literal after prompt\n            let inputQuote1 = thisTestCode.indexOf('(', inputIndex);\n            const inputQuote2 = thisTestCode.indexOf(')', inputQuote1 + 1);\n\n            const preStr = thisTestCode.substring(0, inputQuote1 + 1);\n            const postStr = thisTestCode.substring(inputQuote2);\n\n            thisTestCode = preStr + values[0] + postStr;\n\n        });\n        // eslint-disable-next-line no-eval\n        let codeOutput = silentRunCode(thisTestCode);\n        codeOutput = codeOutput.replace(/\\s/g, '');\n        const result = codeOutput;\n        results.push(result);\n    });\n    return results;\n};\n\n/**\n * @param {String} code The Javascript code to be run\n * @returns {any} The output of the code\n * Runs the code and returns the output, does not display it\n * TODO: do something other than use eval\n */\nexport function silentRunCode(code) {\n    // eslint-disable-next-line no-eval\n    return eval(code);\n}\n\n/**\n * @param {WorkspaceSvg} workspace the workspace to get the code from\n * @param {string} inputFuncDecs\n * @returns {string} the code generated by Blockly for the current workspace\n *\n * Returns the Javascript code string generated by Blockly, with the necessary wrapping code\n */\nexport const getWorkspaceCode = (workspace, inputFuncDecs) => {\n    let code = javascript.javascriptGenerator.workspaceToCode(workspace);\n    javascript.javascriptGenerator.addReservedWords(\"print, input\");\n    const preamble = inputFuncDecs + `\\nlet outputString = \\`\\`;\\n\nfunction print(string) {\n    outputString += string + '\\\\n';\n}\nfunction input(prompt) {\n    return prompt;\n}\n(function () {\n    `;\n    const postscript = `return outputString;\n})();\\n`;\n\n    code = preamble;\n    let blocks = workspace.getTopBlocks(true);\n    for (var b = 0; b < blocks.length; b++) {\n        var block = blocks[b];\n\n        if (block.type === 'start') {\n            code += generateDescendantsCode(block);\n            break;\n        }\n    }\n    code += postscript;\n    return code;\n};\n\n/**\n * @param {BlockSVG} block the block whose descendants are to have their code generated\n * @returns {string} the code generated by Blockly for the descendants of the given block\n */\nfunction generateDescendantsCode(block) {\n    let descendants = block.getChildren(true);\n    let descendantsCode = '';\n    for (let i = 0; i < descendants.length; i++) {\n        let descendant = descendants[i];\n        descendantsCode += Blockly.JavaScript.blockToCode(descendant);\n    }\n    return descendantsCode;\n}\n\n/**\n * Inserts the test results accordion in the area above the Run and Tests buttons\n * @param {any[]} results the results of the tests (pass/fail)\n * @param {{}} testsJSON the tests that were run (for displaying the inputs and outputs)\n * @returns {string} the HTML for the accordion\n */\nexport const testsAccordion = (results, testsJSON) => {\n    const testCaseCount = testsJSON.length;\n\n    let accordion = '<div style=\"max-height: 100%; overflow-y: auto;\">';\n\n    for (let i = 0; i < testCaseCount; i++) {\n        accordion += '<details class=\"card\">';\n        accordion += '<summary class=\"card-header\">';\n        accordion += 'Test ' + (i + 1);\n        // Show if test passed or failed\n        if (results[i] === testsJSON[i].output) {\n            accordion += '<span class=\"badge badge-success float-right\">Passed</span>';\n        } else {\n            accordion += '<span class=\"badge badge-danger float-right\">Failed</span>';\n        }\n        accordion += '</summary>';\n        accordion += '<div class=\"card-body pt-0 pb-0 pl-2 pr-2\">';\n        // eslint-disable-next-line no-loop-func\n        testsJSON[i].inputs.forEach((input) => {\n            for (const key in input) {\n                accordion += '<p class=\"pt-2 m-0\">' + key + ': </p>';\n                accordion += '<pre class=\"mt-1 mb-0 test-input\">' + input[key][0] + '</pre>';\n            }\n        });\n        accordion += '<p class=\"pt-2 border-top mt-2 mb-0\">Test output: </p>';\n        accordion += '<pre class=\"mt-1 mb-0 mr-0 ml-0 test-output\">' + testsJSON[i].output + '</pre>';\n        accordion += '<div class=\"p-0\">';\n        accordion += '<p class=\"pt-2 m-0\">Your output: </p>';\n        accordion += '<pre class=\"pb-2 mt-1 mb-0 ml-0 mr-0 test-output\">' + results[i] + '</pre>';\n        accordion += '</div>';\n        accordion += '</details>';\n    }\n\n    accordion += '</div>';\n    return accordion;\n};\n"],"names":["injectInputBox","i","inputBox","document","createElement","setAttribute","submitButton","innerHTML","getElementById","insertAdjacentElement","replaceCode","code","inputFuncDecsN","formatCodeHTML","debugMode","removeForcedInputFunctions","removeOutputString","removeCustomFunctions","removeWrapperFunction","lines","split","splice","join","runTests","workspace","tests","inputFuncDecs","getWorkspaceCode","results","forEach","test","thisTestCode","inputs","input","prompt","Object","keys","values","inputIndex","lastIndexOf","inputQuote1","indexOf","inputQuote2","preStr","substring","postStr","codeOutput","silentRunCode","result","replace","push","eval","javascript","javascriptGenerator","workspaceToCode","addReservedWords","blocks","getTopBlocks","b","length","block","type","generateDescendantsCode","descendants","getChildren","descendantsCode","descendant","Blockly","JavaScript","blockToCode","testsAccordion","testsJSON","testCaseCount","accordion","output","key"],"mappings":"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"}
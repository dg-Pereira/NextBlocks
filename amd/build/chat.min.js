/**
 *
 * @module      mod_nextblocks/chat
 * @copyright   2023 Duarte Pereira<dg.pereira@campus.fct.unl.pt>
 * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_nextblocks/chat",[],(function(){return{run:function(userName,activityId,saveMessage){var serverUrl=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"ws://localhost:8060",socket=new WebSocket(serverUrl);socket.addEventListener("open",(function(){return chatSetup(socket,userName,activityId,saveMessage)})),socket.addEventListener("message",(function(event){return appendMessage(event.data,activityId)})),socket.addEventListener("close",(function(){return socketError(activityId,"Connection closed by server")})),socket.addEventListener("error",(function(){return socketError(activityId)}))},populate:function(getMessages,activityId){getMessages(100,activityId).then((function(messages){messages.forEach((function(dbMessage){var message={type:"dbMessage",sender:dbMessage.username,text:dbMessage.message,activity:activityId,timestamp:dbMessage.timestamp};appendMessage(message,activityId,!0)}))}))}}}));var socketError=function(activityId){var errorMessage=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Connection error",errorJSON={type:"error",sender:"System",text:errorMessage,activity:activityId,timestamp:Date.now()};appendMessage(errorJSON,activityId,!0)},appendMessage=function(message,activityId){var isParsed=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(isParsed||(message=parseMessage(message)),activityId===message.activity){var chatDiv=document.getElementById("messages"),timestampDate=new Date(message.activity);chatDiv.innerHTML+="<p>(".concat(timestampDate.getHours(),":").concat(timestampDate.getMinutes(),") \n            ").concat(message.sender,": ").concat(message.text,"</p>")}},parseMessage=function(message){var msg;try{msg=JSON.parse(message)}catch(e){throw new Error("Invalid message format")}return msg},chatSetup=function(socket,userName,activityId,saveMessage){var msgForm=document.querySelector("form.msg-form");msgForm.addEventListener("submit",(function(event){return function(event){event.preventDefault();var msgField=document.getElementById("msg"),msgText=msgField.value,timestamp=Date.now();saveMessage(msgText,userName,activityId,timestamp);var msg={type:"normal",sender:userName,text:msgText,activity:activityId,timestamp:timestamp};msg=JSON.stringify(msg),socket.send(msg),msgField.value=""}(event)}))};

//# sourceMappingURL=chat.min.js.map